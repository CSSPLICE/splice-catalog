<!DOCTYPE html>
<html>
  <%- include('../partials/head') -%>
  <link rel="stylesheet" href="/css/style.css">
  <%- include('../partials/header') -%>

  <body>
    <div class="container search-sidebar-layout">

      <%- include('../partials/filter') -%>

      <%
        const q = (typeof query === 'string') ? query : '';
        const selectedFeatures = Array.isArray(features)
          ? features
          : (features ? [features] : []);
      %>

      <main class="search-content">

        <div style="margin-bottom: 1rem;">
          <!-- add button to download the JSON results -->
          <form action="/search/export" method="get" style="display:inline;">
            <input type="hidden" name="query" value="<%= q %>">
            <% selectedFeatures.forEach(t => { %>
              <input type="hidden" name="features" value="<%= t %>">
            <% }) %>

            <button type="submit" class="btn btn-primary"> Download results </button>
          </form>
        </div>


        <div class="d-flex justify-content-between align-items-center mb-3">

          <div id="recordCount" class="fw-semibold text-muted">
            Showing 0-0 of 0 results
          </div>

          <div>
            <label for="itemsPerPage" class="me-2">Items per page:</label>
            <select id="itemsPerPage" class="form-select d-inline-block w-auto">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

        </div>

        <%- include('../pages/table', { items: results || [], isSearchPage: true }) %>


        <div class="pagination">
        </div>
      </main>
    </div>

    <script src="/js/searchparams.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("descriptionModal");
        const modalText = document.getElementById("fullDescription");

        document.querySelectorAll(".short-description").forEach((el) => {
          el.addEventListener("click", () => {
            modalText.textContent = el.getAttribute("data-description") || "Detailed Description.";
            modal.style.display = "block";
          });
        });

        document.querySelector(".close").addEventListener("click", () => {
          modal.style.display = "none";
        });
      });
    </script>

    <script>
    const allItems = <%- JSON.stringify(results || []) %>;

    let currentPage = 1;
    let itemsPerPage = 25;

    const recordCountEl = document.getElementById("recordCount");
    const paginationEl = document.querySelector(".pagination");
    const itemsPerPageSelect = document.getElementById("itemsPerPage");
    const tableBody = document.querySelector("tbody");

    function renderTable() {
      tableBody.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = allItems.slice(start, end);

      if (pageItems.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='6' class='text-center'>No results</td></tr>";
        recordCountEl.textContent = "Showing 0–0 of 0 results";
        return;
      }

      pageItems.forEach((item, index) => {
        const row = document.createElement("tr");
        const rowNumber = (currentPage - 1) * itemsPerPage + index + 1;

        row.innerHTML = `
          <td>${rowNumber}</td>
          <td><a href="/catalog/item/${encodeURIComponent(item.id)}">${item.title}</a></td>
          <td>${Array.isArray(item.features) ? item.features.join(", ") : item.features || ""}</td>
          <td>${item.description?.split(" ").slice(0, 20).join(" ")}...</td>
          <td><a href="${item.iframe_url}" target="_blank">${item.platform_name}</a></td>
          <td>${(item.keywords || []).join(", ")}</td>
        `;

        tableBody.appendChild(row);
      });

      const startNum = Math.min((currentPage - 1) * itemsPerPage + 1, allItems.length);
      const endNum = Math.min(currentPage * itemsPerPage, allItems.length);

      recordCountEl.textContent =
        `Showing ${startNum}–${endNum} of ${allItems.length} results`;
    }

    function renderPagination() {
      paginationEl.innerHTML = "";

      const totalPages = Math.ceil(allItems.length / itemsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "btn btn-sm btn-outline-primary me-1";

        if (i === currentPage) btn.classList.add("active");

        btn.onclick = () => {
          currentPage = i;
          renderTable();
          renderPagination();
        };

        paginationEl.appendChild(btn);
      }
    }

    itemsPerPageSelect.addEventListener("change", () => {
      itemsPerPage = Number(itemsPerPageSelect.value);
      currentPage = 1;
      renderTable();
      renderPagination();
    });

    renderTable();
    renderPagination();
  </script>


  </body>

  <%- include('../partials/footer') -%>
</html>
